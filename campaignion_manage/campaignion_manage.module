<?php

use \Drupal\campaignion_manage as cm;

/**
 * Implements hook_menu().
 */
function campaignion_manage_menu() {
  $items['admin/manage'] = array(
    'title'            => t('Manage Campaignion'),
    'page callback'    => 'campaignion_manage_content_page',
    'access arguments' => array('administer nodes'),
    'type'             => MENU_NORMAL_ITEM,
  );

  $items['admin/manage/content_and_actions'] = array(
    'title'  => t('Content'),
    'type'   => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -1,
  );

  $items['admin/manage/action_templates'] = array(
    'title'            => t('Action Templates'),
    'page callback'    => 'campaignion_manage_action_templates',
    'access arguments' => array('administer nodes'),
    'type'             => MENU_LOCAL_TASK,
  );

  $items['admin/supporters'] = array(
    'title' => t('Manage Supporters'),
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array('manage redhen contacts'),
    'page callback' => 'campaignion_manage_supporters_page',
  );
  return $items;
}

/**
 * Implements hook_admin_paths().
 */
function campaignion_manage_admin_paths() {
  return array(
    'campaignion/manage/*' => TRUE,
  );
}

/**
 * Implements hook_theme().
 */
function campaignion_manage_theme() {
  $theme['campaignion_manage_node'] = array(
    'variables' => array(
      'node' => NULL,
      'translation_set' => FALSE,
    ),
    'file' => 'campaignion_manage.theme.inc',
  );
  $theme['campaignion_manage_contact'] = array(
    'variables' => array(
      'contact' => NULL,
    ),
    'file' => 'campaignion_manage.theme.inc',
  );
  return $theme;
}

function campaignion_manage_action_list($entity_type) {
  $my_actions = array();
  $actions = actions_list();
  foreach($actions as $id => &$action) {
    if ($action['type'] == $entity_type) {
      $my_actions[$id] = &$action;
    }
  }
  return $my_actions;
}

/**
 * helper function for page callbacks
 */
function campaignion_manage_build_page(cm\Query\Content $baseQuery) {
  // add style + js for interface
  drupal_add_js(drupal_get_path('module', 'campaignion_manage') . '/js/manage_bulk.js');
  drupal_add_js(drupal_get_path('module', 'campaignion_manage') . '/js/manage_filter.js');
  drupal_add_css(drupal_get_path('module', 'campaignion_manage') . '/css/manage_bulk.css');

  $listing = new cm\ContentListing($baseQuery);
  // filter for node title created separately because it has to be enabled
  // by default and we need the machine name for the filter
  $filters['title'] = new cm\Filter\ContentTitle();
  $defaultActive = array('title');
  if (module_exists('campaignion_microsite')) {
    $filters['microsite'] = new cm\Filter\ContentMicrosite($baseQuery->getQuery());
  }
  if (module_exists('campaignion_campaign')) {
    $filters['campaign'] = new cm\Filter\ContentCampaign($baseQuery->getQuery());
  }
  $filters['language'] = new cm\Filter\ContentLanguage($baseQuery->getQuery());
  $filters['type'] = new cm\Filter\ContentType($baseQuery->getQuery());
  $filters['status'] = new cm\Filter\ContentStatus();

  $filterForm = new cm\FilterForm($filters, $defaultActive);
  $baseQuery->setFilter($filterForm);

  $baseQuery->page(20);

  $bulkOpForm = new cm\BulkOpForm($listing, array(
    new cm\PublishBulkOp(),
    new cm\UnpublishBulkOp(),
  ));

  // ATTENTION: drupal_get_form() has to be called before $baseQuery->execute()
  //            as query conditions are set in the form submit handler.
  $output = array(
    'filter' => drupal_get_form('campaignion_manage_filter_form', $filterForm),
    'bulkop_listing' => drupal_get_form('campaignion_manage_bulkops_form', $bulkOpForm),
    'pager' => array(
      '#theme' => 'pager',
    ),
  );
  return $output;
}

/**
 * Page callback: Manage Content & Actions page
 */
function campaignion_manage_content_page() {
  drupal_set_title(t('Manage Content & Actions'), PASS_THROUGH);

  $baseQuery = new \Drupal\campaignion_manage\Query\Content();

  return campaignion_manage_build_page($baseQuery);
}

/**
 * Page callback: Action Templates page
 */
function campaignion_manage_action_templates() {
  drupal_set_title(t('Action Templates'), PASS_THROUGH);

  $baseQuery = new \Drupal\campaignion_manage\Query\Template();

  return campaignion_manage_build_page($baseQuery);
}

/**
 * Page callback: Manage your supporters page
 */
function campaignion_manage_supporters_page() {
  // add style + js for interface
  drupal_add_js(drupal_get_path('module', 'campaignion_manage') . '/js/manage_bulk.js');
  drupal_add_js(drupal_get_path('module', 'campaignion_manage') . '/js/manage_filter.js');
  drupal_add_css(drupal_get_path('module', 'campaignion_manage') . '/css/manage_bulk.css');

  drupal_set_title(t('Manage your supporters'), PASS_THROUGH);

  $baseQuery = new cm\Query\Supporter();
  
  $listing = new cm\SupporterListing($baseQuery);

  $filters = array();
  $defaultActive = array();
  if (module_exists('campaignion_supporter_tags')) {
    $filters['tags'] = new cm\Filter\SupporterTag($baseQuery->getQuery());
  }
  $filters['name'] = new cm\Filter\SupporterName();
  $defaultActive    = array('name');
  $filterForm = new cm\FilterForm($filters, $defaultActive);
  $baseQuery->setFilter($filterForm);
  $baseQuery->page(20);
  $bulkOpForm = new cm\BulkOpForm($listing, array());
  
  $output = array(
    'filter' => drupal_get_form('campaignion_manage_filter_form', $filterForm),
    'bulkop_listing' => drupal_get_form('campaignion_manage_bulkops_form', $bulkOpForm),
    'pager' => array(
      '#theme' => 'pager',
    ),
  );
  return $output;
}

function campaignion_manage_forms() {
  $forms['campaignion_manage_filter_form'] = array(
    'callback' => 'campaignion_manage_form',
  );
  $forms['campaignion_manage_bulkops_form'] = array(
    'callback' => 'campaignion_manage_form',
  );
  return $forms;
}

function campaignion_manage_form($form, &$form_state, $formObj) {
  $form['#formObj'] = $formObj;
  return $formObj->form($form, $form_state);
}

function campaignion_manage_form_process($form, &$form_state) {
  $form['#formObj']->process($form, $form_state);
  return $form;
}

function campaignion_manage_form_submit($form, &$form_state) {
  $form['#formObj']->submit($form, $form_state);
}

function campaignion_manage_element_info() {
  $types['campaignion_manage_listing'] = array(
    '#theme' => 'table',
    '#process' => array('campaignion_manage_form_process'),
  );
  return $types;
}
